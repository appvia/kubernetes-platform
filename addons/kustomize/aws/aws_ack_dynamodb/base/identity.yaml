---
apiVersion: iam.services.k8s.aws/v1alpha1
kind: Role
metadata:
  name: aws-ack-dynamodb
  namespace: ack-system
spec:
  # The name the role will have in AWS IAM
  name: aws-ack-dynamodb
  # Description of the role
  description: "IAM Role used by the AWS ACK DynamoDB Controller to manage DynamoDB resources"
  # The trust policy, allowing an entity to assume the role
  assumeRolePolicyDocument: |
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Principal": {
            "Service": "pods.eks.amazonaws.com"
          },
          "Action": [
            "sts:AssumeRole",
            "sts:TagSession"
          ]
          "Condition": {
            "StringEquals": {
              "aws:RequestTag/kubernetes-namespace": ["ack-system"]
            }
          }
        }
      ]
    }
  # List of policies to attach to the role
  policies:
    - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
---
apiVersion: eks.services.k8s.aws/v1alpha1
kind: PodIdentityAssociation
metadata:
  name: aws-ack-dynamodb-association
  namespace: ack-system
spec:
  # The name of the Kubernetes Service Account to associate
  serviceAccount: aws-ack-dynamodb-controller
  # The Kubernetes Namespace of the Service Account (must match metadata.namespace)
  namespace: ack-system
  # The reference to the IAM role
  roleRef:
    from:
      name: aws-ack-dynamodb
      namespace: ack-system
  # Tags to apply to the pod identity association
  tags:
    kubernetes-namespace: ack-system
    kubernetes-service-account: aws-ack-dynamodb-controller
