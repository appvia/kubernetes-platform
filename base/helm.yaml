---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: helm-platform
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  goTemplate: true

  ## Add a strategy permiting us to control the ordering of resources
  ## by using labelling.
  strategy:
    type: RollingSync
    rollingSync:
      steps:
        - matchExpressions:
            - key: phase
              operator: In
              values:
                - primary
        - matchExpressions:
            - key: phase
              operator: In
              values:
                - secondary
        - matchExpressions:
            - key: phase
              operator: NotIn
              values:
                - primary
                - secondary

  # Generate applications
  generators:
    - merge:
        mergeKey: cluster_name
      generators:
        - cluster:
            selector:
              matchExpressions:
                - key: environment
                  operator: Exists
                - key: cluster_name
                  operator: Exists
        - git:
            repoURL: "{{ .Values.platform_repository }}"
            revision: "{{ .Values.platform_revision }}"
            files:
              - path: "platform/{{ .Values.cloud_vendor }}/**/*.yaml"
              - path: "platform/oss/**/*.yaml"
            plugin:
              name: argocd-platform-config
      ## Filter on only those files with the correct values
      selector:
        matchExpressions:
          - key: "{{ .feature_gate }}"
            operator: Exists
          - key: "{{ .feature_gate }}"
            operator: In
            values: ["true"]
          - key: helm.chart
            operator: Exists
          - key: helm.version
            operator: Exists
          - key: helm.repository
            operator: Exists

  ## Sync Policy for the ApplicationSet
  syncPolicy:
    # Prevents ApplicationSet controller from modifying Applications. Delete is allowed.
    applicationsSync: create-delete
    # Prevent an Application's child resources from being deleted, when the parent Application is deleted
    # preserveResourcesOnDeletion: true

  ## Template out an application for each of the tenant applications
  template:
    metadata:
      name: "platform-helm-{{ .path.basenameNormalized }}"
      namespace: argocd
      labels:
        app.kubernetes.io/name: argocd
        app.kubernetes.io/managed-by: argocd
        app.kubernetes.io/instance: argocd
        app.kubernetes.io/part-of: argocd
        app.kubernetes.io/environment: "{{ .values.environment }}"
        app.kubernetes.io/type: helm
        phase: primary

    spec:
      project: default
      sources:
        - repoURL: "{{ .helm.repository }}"
          targetRevision: "{{ .helm.version }}"
          chart: "{{ .helm.chart }}"
          helm:
            releaseName: "{{ default .path.basenameNormalized .helm.releaseName }}"
            valueFiles:
              - "$values/{{ .path.path }}/values/all.yaml"
              - "$values/{{ .path.path }}/values/{{ .environment }}.yaml"
            ignoreMissingValueFiles: true
        - repoURL: "{{ .metadata.annotations.platform.repository }}"
          targetRevision: "{{ .metadata.annotations.platform.revision }}"
          ref: values

      ## Destination is the cluster to deploy to
      destination:
        name: in-cluster
        ## /applications/[1]/DIRECTORY/FILE.yaml
        namespace: "{{ default (index .path.segments 1) .helm.namespace }}"

      ## Sync policy for the application
      syncPolicy:
        automated:
          selfHeal: true
          prune: true
        retry:
          backoff:
            duration: '{{ default "180s" .sync.retryBackoff }}'
            maxDuration: '{{ default "5m" .sync.retryMaxDuration }}'
        # Use server-side apply for better efficiency and interop
        # between controllers making partial changes to manifests.
        # Also enable apply out of sync only rather than trying to
        # apply all resources in the application.
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
          - ApplyOutOfSyncOnly=true
