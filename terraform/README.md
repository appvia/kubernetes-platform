# Terraform

This folder contains the Terraform configuration for provisioning an EKS cluster and bootstrapping it with the Kubernetes platform. The code here is provided as an example implementation only, and not reflective of a production grade deployment.

The Terraform code will:

- Create a new EKS cluster in AWS
- Configure the necessary networking and IAM roles
- Bootstrap the cluster with the platform components
- Set up initial GitOps configuration

Note: This is intended as a reference implementation. For production use, you should carefully review and customize the configuration according to your requirements.

## Provision a Development Cluster

You can provision a development cluster using

```shell
terraform apply -var-file=variables/dev.tfvars
```

<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                     | Version  |
| ------------------------------------------------------------------------ | -------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >= 1.6.0 |
| <a name="requirement_aws"></a> [aws](#requirement_aws)                   | >= 5.0.0 |
| <a name="requirement_helm"></a> [helm](#requirement_helm)                | >= 2.0.0 |
| <a name="requirement_kubectl"></a> [kubectl](#requirement_kubectl)       | ~> 2.0   |

## Providers

No providers.

## Modules

| Name                                                        | Source                                    | Version |
| ----------------------------------------------------------- | ----------------------------------------- | ------- |
| <a name="module_eks"></a> [eks](#module_eks)                | ../../terraform-aws-eks                   | n/a     |
| <a name="module_platform"></a> [platform](#module_platform) | github.com/appvia/terraform-kube-platform | v0.1.3  |

## Resources

No resources.

## Inputs

| Name                                                                                                                        | Description                                                                                 | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Default          | Required |
| --------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------- | :------: |
| <a name="input_cluster_path"></a> [cluster_path](#input_cluster_path)                                                       | The name of the cluster                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | n/a              |   yes    |
| <a name="input_tags"></a> [tags](#input_tags)                                                                               | The tags to apply to all resources                                                          | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | n/a              |   yes    |
| <a name="input_access_entries"></a> [access_entries](#input_access_entries)                                                 | Map of access entries to add to the cluster.                                                | <pre>map(object({<br/> ## The kubernetes groups<br/> kubernetes_groups = optional(list(string))<br/> ## The principal ARN<br/> principal_arn = string<br/> ## The policy associations<br/> policy_associations = optional(map(object({<br/> # The policy arn to associate<br/> policy_arn = string<br/> # The access scope (namespace or clsuter)<br/> access_scope = object({<br/> # The namespaces to apply the policy to (optional)<br/> namespaces = optional(list(string))<br/> # The type of access (namespace or cluster)<br/> type = string<br/> })<br/> })))<br/> }))</pre>                                                 | `null`           |    no    |
| <a name="input_argocd_repositories"></a> [argocd_repositories](#input_argocd_repositories)                                  | A collection of repository secrets to add to the argocd namespace                           | <pre>map(object({<br/> ## The description of the repository<br/> description = string<br/> ## An optional password for the repository<br/> password = optional(string, null)<br/> ## The secret to use for the repository<br/> secret = optional(string, null)<br/> ## The secret manager ARN to use for the secret<br/> secret_manager_arn = optional(string, null)<br/> ## An optional SSH private key for the repository<br/> ssh_private_key = optional(string, null)<br/> ## The URL for the repository<br/> url = string<br/> ## An optional username for the repository<br/> username = optional(string, null)<br/> }))</pre> | `{}`             |    no    |
| <a name="input_cluster_endpoint_public_access"></a> [cluster_endpoint_public_access](#input_cluster_endpoint_public_access) | The public access to the cluster endpoint                                                   | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `true`           |    no    |
| <a name="input_enable_external_secrets"></a> [enable_external_secrets](#input_enable_external_secrets)                      | Indicates we should enable the external secrets platform                                    | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `true`           |    no    |
| <a name="input_enable_nat_gateway"></a> [enable_nat_gateway](#input_enable_nat_gateway)                                     | Enable the NAT gateway                                                                      | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `true`           |    no    |
| <a name="input_enable_platform"></a> [enable_platform](#input_enable_platform)                                              | Indicates we should install the platform                                                    | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `true`           |    no    |
| <a name="input_enable_terranetes"></a> [enable_terranetes](#input_enable_terranetes)                                        | Indicates we should enable the terranetes platform                                          | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `true`           |    no    |
| <a name="input_hub_account_id"></a> [hub_account_id](#input_hub_account_id)                                                 | When using a hub deployment options, this is the account where argocd is running            | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `null`           |    no    |
| <a name="input_nat_gateway_mode"></a> [nat_gateway_mode](#input_nat_gateway_mode)                                           | The NAT gateway mode                                                                        | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `"single_az"`    |    no    |
| <a name="input_private_subnet_netmask"></a> [private_subnet_netmask](#input_private_subnet_netmask)                         | The netmask for the private subnets                                                         | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `24`             |    no    |
| <a name="input_public_subnet_netmask"></a> [public_subnet_netmask](#input_public_subnet_netmask)                            | The netmask for the public subnets                                                          | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `24`             |    no    |
| <a name="input_revision_overrides"></a> [revision_overrides](#input_revision_overrides)                                     | Revision overrides permit the user to override the revision contained in cluster definition | <pre>object({<br/> ## The platform revision or branch to use<br/> platform_revision = optional(string, null)<br/> ## The tenant revision or branch to use<br/> tenant_revision = optional(string, null)<br/> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                | `null`           |    no    |
| <a name="input_vpc_cidr"></a> [vpc_cidr](#input_vpc_cidr)                                                                   | The CIDR block for the VPC, if not using an existing VPC                                    | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `"10.90.0.0/16"` |    no    |
| <a name="input_vpc_id"></a> [vpc_id](#input_vpc_id)                                                                         | The VPC ID when using an existing VPC                                                       | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `null`           |    no    |

## Outputs

| Name                                                                                                                                                  | Description                                                        |
| ----------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| <a name="output_argocd_spoke_role_arn"></a> [argocd_spoke_role_arn](#output_argocd_spoke_role_arn)                                                    | When provisioning a spoke, the is the IAM role the hub must assume |
| <a name="output_eks_cluster_certificate_authority_data"></a> [eks_cluster_certificate_authority_data](#output_eks_cluster_certificate_authority_data) | The certificate authority of the EKS cluster                       |
| <a name="output_eks_cluster_endpoint"></a> [eks_cluster_endpoint](#output_eks_cluster_endpoint)                                                       | The endpoint of the EKS cluster                                    |
| <a name="output_eks_cluster_name"></a> [eks_cluster_name](#output_eks_cluster_name)                                                                   | The name of the EKS cluster                                        |

<!-- END_TF_DOCS -->

